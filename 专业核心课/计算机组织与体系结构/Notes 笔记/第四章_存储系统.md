# 第四章 存储系统

By: 诚夏 SincereXIA @ XD Univ.

<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/cn/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/cn/">知识共享署名-非商业性使用 3.0 中国大陆许可协议</a>(Creative Commons Attribution 3.0 China Mainland License)进行许可。

------

![mark](http://media.sumblog.cn/blog/180516/Jhc719I8D3.png?imageslim)

## 存储器

### 存储器分类

1. 介质分类：半导体、磁表面、光学器件
2. 用途：内存（主存&Cache）、控制存储器、外部存储器
3. 易失性：易失、非易失
4. 存取方式：随机读写、顺序存储
5. 读写功能：读写、只读

### 性能指标

存储容量、存取时间、存储周期、存储器带宽

## 内存（主存储器）

1. RAM 的内部结构以及工作原理 （不要求掌握）

2. ### 静态读写存储器 SRAM

   1. 引脚说明：

      | $ \overline{WE}$ | $ \overline{OE}$ | $ \overline{CS_1}$ | $ CS_2$  | $D_0\sim D_7$  | $A_0\sim A_{12}$ |
      | ---------------- | ---------------- | ------------------ | -------- | -------------- | ---------------- |
      | 写允许信号       | 读允许信号       | 片选信号           | 片选信号 | 8位数据线      | 13位地址线       |
      | 0有效            | 0有效            | 0有效              | 1有效    | 总线数据线相接 | 通常接低位地址线 |

   2. SRAM 的连接

      1. 不拓展连接

         ![mark](http://media.sumblog.cn/blog/180507/37if26GG3K.png?imageMogr2/thumbnail/!80p)

         **使用与非门进行片选使能；信号为0的地址线，先接入非门，再与与非门相接**

      2. **字拓展连接**

         **一片SRAM芯片的字容量不足，使用此方法拓展，即拓展的最小单位为 字**

         ![mark](http://media.sumblog.cn/blog/180507/3KgAJccK6F.png?imageMogr2/thumbnail/!85p)

         连接方法：

         1. 低位地址线（A0~A12）直接与每一片地址线相接
         2. 高位地址线（A15~A13）接入 74LS138 （3-8译码器）的 C、B、A 三端，通过给定地址线状态，确定选用的输出端，输出端直接接到片选端
         3. 使能端接入空余高位地址线，保证译码器处于使能状态

      3. **位拓展连接**

         **字长位数的扩充**

         ![mark](http://media.sumblog.cn/blog/180507/F3l2DaFL81.png?imageMogr2/thumbnail/!85p)

         连接方法：

         1. 低位地址线，和控制线公用，数据线单独分开连接
         2. 如果有高位地址线，全部接入 74138，判断 CBA 对应的有效输出端口，进行整体使能

      4. 80486 总线介绍：

         80486 为 **32位系统**，32位数据需要四个存储体保存 （位拓展）

         **不存在 A0 A1 地址线**，取代它的是 **四个 体选择信号** $\overline{BE_{0\sim3}}$

         使用三个控制信号，控制主存和接口的读写，110代表读存储，111代表写存储，使用译码器，转换为存储器适配的读写信号

         ![mark](http://media.sumblog.cn/blog/180507/1dhlKLhAaE.png?imageMogr2/thumbnail/!85p)

## 只读存储器 ROM

### 分类：

1. 掩膜 ROM：制出即用，成本低，数据不可改
2. 一次编程 ROM
3. 擦去重写 PROM：**EPROM 紫外线擦除**、**EEPROM 电擦除**

## 其他存储器

1. 多端口存储器：同时进行多个地址的读写

2. **多体交叉存储器**

   1. 多体并行存储器：

      处理器对主存的访问是多个存储器同时进行，**需要更宽的数据总线宽度**

   2. 多体交叉存储器：

      **顺序方式**：高位选模块，低位选块内地址

      某个模块进行存取时，其他模块不工作

      - 优点：某一模块出现故障时，其他模块可以照常工作，通过增添模块来扩充存储器容量比较方便
      - 缺点：各模块串行工作，存储器的带宽受到了限制

      **交叉方式**：**高位选块内地址，低位选模块**

      连续地址分布在相邻的不同模块内，同一个模块内的地址都是不连续的。

      - 优点：对连续字的成块传送可实现多模块流水式并行存取，大大提高存储器的带宽。使用场合为成批数据读取。

      **多个存储器轮流访问**

      ![mark](http://media.sumblog.cn/blog/180516/Gj8aG5889L.png?imageMogr2/thumbnail/!85p)

      设存储器的总个数为 m

      多体交叉存储器从每个存储器各读取出一个字的总时间为：
      $$
      t(总时间)=T(存储器的时间周期)+(m-1)\Delta t(总线时间周期)
      $$
      总信息量：
      $$
      q=总线字长*存储器个数
      $$
      带宽：
      $$
      W=\frac{q}{t}
      $$





## 高速缓冲存储器

### 工作原理

- 设计依据：

  程序执行的时间和空间的局部性原理 **CPU这次访问过的数据，下次有很大的可能也是访问附近的数据。**，程序运行时，直接访问这种高速小容量的存储器，提高 CPU 的程序执行速度

- 工作流程：

  CPU 读主存时，便把地址同时送给Cache和主存，Cache控制逻辑依据地址判断此字是否在Cache中，若在此字立即传送给CPU，否则，则用主存读周期把此字从主存读出送到 CPU，与此同时，把含有这个字的整个数据块从主存读出送到cache中。 

  **CPU与Cache之间的数据传送是以字为单位,主存与Cache之间的数据传送是以块为单位**

### Cache 地址映射

原型系统参数：主存64MB，地址线数26根；Cache 32KB，地址线数15根，块大小为4KB，地址线数12根。

#### 1. 全相连地址映射

- 特点

    - 映射方法：**多对多**
    - 将地址分为**两部分（块号和块内地址）**，在内存块写入Cache时，同时写入块号标记
    - 优点：**冲突概率小，cache利用高**
    - 缺点：比较器难实现，需要一个访问速度很快代价高的相联存储器，适用于小容量的Cache

    ![mark](http://media.sumblog.cn/blog/180516/je8eBDjCLc.png?imageMogr2/thumbnail/!60p)

- 地址变换

    - 主存地址分为：主存块号、块内地址
    - 将主存块号与相连存储器内所有地址比较，找到 Cache 地址，该地址与块内地址拼接，得到的就是 Cache 地址

    ![mark](http://media.sumblog.cn/blog/180516/8da2m3Aecg.png?imageMogr2/thumbnail/!60p)

#### 2. 直接映射地址变换 （区块二级架构）

- 特点

  - 映射方法：一对多

    **i= j mod m**   （其中cache行号为i，主存块号为j，m为cache总行数）

    主存的 $0,m,2m......$映射到cache的第0行；

    主存的 $1,m+1,2m+1......$ 映射到cache 的第1行；

    - 地址分为三部分（区号，块号，块内地址）

  - 优点：硬件简单，成本低

  -  缺点：冲突概率高，适用于较大容量的Cache

  ![mark](http://media.sumblog.cn/blog/180516/2Ka98GjbFl.png?imageMogr2/thumbnail/!60p)

- 地址变换

  - 通过块号，在静态存储器中线性查找到 Cache 区号，主存区号与 Cache 区号比较
  - Cache 块号 与 块内地址 拼接，得到 Cache 地址

  ![mark](http://media.sumblog.cn/blog/180516/f209LiElE6.png?imageMogr2/thumbnail/!85p)

#### 3. 组相连地址变换 （区组块三级架构）

- 特点

  - 前两者的结合（一对多映射）（组内全相连，组间直接映射）

  - Cache分组，组间采用直接映射方式，组内采用全相联的映射方式

  - 地址分四部分：主存区号、组号、块号、块内地址

  - 若 Cache 分组数为 U，组内容量为 V

    组号：q= j mod U（主存第j块内容拷贝到 Cache 的 q 组中的某行）

    若 v=1，则为直接相联映射方式；若 u=1，则为全相联映射方式

  ![mark](http://media.sumblog.cn/blog/180516/Bjjf2ija6g.png?imageMogr2/thumbnail/!60p)

- 地址变换

  - 主存区号和块号拼接，在相联存储器的对应组内，进行全搜索，找到 Cache 块号
  - 组号， Cache 块号和块内地址拼接，得到 Cache 地址

  ![mark](http://media.sumblog.cn/blog/180516/GgjAk8HCE8.png?imageMogr2/thumbnail/!85p)

### 替换算法

1. 随机替换算法 （RAND）

2. 先进先出算法 （FIFO）

3. **近期最少使用（LRU）**

   被访问的行计数器置0，其他的计数器增加1，换值最大的块，符合cache的工作原理

4. **最不经常使用（LFU）**

   被访问的行计数器增加1，需要替换时，换值小的块，并将所有快清零，不能反映近期cache的访问情况 

5. 最优替换算法（OPT）

### 主存 —— Cache 内容一致性

1. 写回法
   - 写 Cache 命中：只讲数据写入 Cache，当块被替换出 Cache 时，才写回主存
   - 写 Cache 未命中：将主存块调入 Cache，数据写入 Cache，对主存的修改在块调出后进行
   - 每个 Cache 需要配置一个修改位
2. 全写法
   - 写 Cache 命中：同时修改 Cache 和主存
   - 写 Cache 未命中：直接向主存写入

### Cache 性能分析

1. 命中率
   $$
   命中率 = \frac{Cache 完成存取的总次数}{主存+Cache完成存取的总次数}
   $$

2. 平均访问周期
   $$
   Cache 命中率*Cache访问周期+（1-Cache命中率）*主存访问周期
   $$

3. 加速比
   $$
   S_p = 主存访问周期/平均访问周期
   $$






## 虚拟存储器

### 基本概念

> 虚拟存储器只是一个容量非常大的存储器的逻辑模型，不是任何实际的物理存储器。它借助于磁盘等辅助存储器来扩大主存容量，使之为更大或更多的程序所使用。以透明的方式给用户提供了一个比实际主存空间大得多的程序地址空间。

- 与 Cache 系统的区别
  - 虚拟内存未命中损失更大
  - Cache缺失时主要由硬件控制进行替换操作，而虚拟存储器的替换主要由操作系统控制。
  - 处理器的地址大小决定了虚拟存储器的大小，但和Cache大小无关。
  - 辅存除了作为存储器层次中内存的下一级后备存储器外，还被用于文件系统，文件系统通常不是地址空间的一部分，但占据了辅存的大部分空间。

### 虚存的管理

1. 段式虚存

   > 段是按照程序的逻辑结构划分成的多个相对独立部分，作为独立的逻辑单位。 

   - 优点：易于编译、管理、修改、维护，共享。长度可变；适合模块化程序的设计；便于信息保护
   - 缺点：内存分配复杂，容易造成内存碎片

   **地址变换**

   ![mark](http://media.sumblog.cn/blog/180516/m9785jafhi.png?imageMogr2/thumbnail/!60p)

2. 页式虚存

   > 页是主存物理空间中划分出来的等长的固定区域。 

   - 优点：方便造页表，调度算法简单
   - 缺点：不利于保护和共享；模块性查；页表很长

   **地址变换**

   ![mark](http://media.sumblog.cn/blog/180516/0AH4L3a7Ac.png?imageMogr2/thumbnail/!60p)

   - 快表和慢表

     将页表中最活跃的部分放在 Cache 存储器中构成快表，这样快表的查找和管理全用硬件实现

3. 段页式虚存

   > 段页式管理采用分段和分页结合的方法。程序按模块分段，段内再分页，进入主存以页为基本信息传送单位，用段表和页表进行两级定位管理。

   ![mark](http://media.sumblog.cn/blog/180516/f5l9fk244c.png?imageMogr2/thumbnail/!85p)



## 外部存储器

### 1. 磁表面存储器

- 原理

  > 硬磁材料的剩磁状态来保存二进制信息

- 记录方式

  归零制（RZ） 、不归零制（NRZ） 、见1就变不归零制（NRZ1） 、调频制（FM）、改进调频制（MFM） 、调相制（PM）  

  ![mark](http://media.sumblog.cn/blog/180516/9akA8iL32K.png?imageMogr2/thumbnail/!60p)

- 磁盘结构

  ```mermaid
  graph LR;
  记录面-->磁道
  磁道-->扇区
  ```








