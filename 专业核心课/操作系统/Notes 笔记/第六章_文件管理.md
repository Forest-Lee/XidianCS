# 第六章 文件管理

要求识记：文件的定义、文件系统的定义、文件系统提供的文件操作功能；文件的逻辑结构的含义及分类；文件物理结构的含义；文件的3种存取方法；文件路径名的组成；文件共享有3种方法；文件存取控制的5种方法；文件系统转储的重要性和转储的常用两种方法。

要求理解：文件系统的功能；文件物理组织的4种结构及其优缺点；文件控制块中主要内容及其作用；目录的3种结构及其优缺点；多级目录结构中工作目录的作用；文件存储空间管理的3种方法的使用方法；文件存取控制的3个功能；

## 文件

**定义：** 文件是是**记录在外存上的**，具有**符号名**的，在**逻辑上具有完整意义**的一组**相关信息项的集合**。 

> **文件的组成部分：**
>
> 1. **文件体：** 文件真实的内容
> 2. **文件说明：** 操作系统为了管理文件所用到的信息

### 文件系统：

**定义：** 是操作系统中实现文件统一管理的一组软件和相关数据的集合，是专门负责管理和存取文件信息的软件机构

> 文件系统的功能（了解）：
>
> 按名存取、统一的用户接口、并发访问和控制文件、安全性控制、优化性能、差错恢复

### 文件的结构

- **逻辑结构：**是从用户观点出发，所观察到的文件组织形式，是用户可以直接处理的数据及其结构，它独立于物理特性，又称为文件组织 (File Organization)。 

  - **有结构的记录式文件**：定长记录、变长记录，两种记录在处理前，每个记录的长度是可知的
  - **无结构的流式文件：** 文件体为字节流，采用顺序访问方式

- **物理结构（四种）：**是指文件的内部组织形式，即文件在物理存储设备上的存放方法 

  - **连续结构（顺序结构）**

    - 优点：
      1. 存储方式简单。
      2. 对文件记录进行批量存取时，其存取效率较高。
      3. 支持定长记录的直接存取，可以通过计算获得存储位置。
    - 缺点： 
      1. 不支持随机查找。如果要随机地查找或修改单个记录，此时系统需要逐个地查找诸记录，性能较差，尤其是当文件较大时情况将更为严重。
      2. 存在外部碎片。
      3. 不便于记录的增加或删除操作。

  - **链接结构：**将逻辑上连续的文件信息存放在不连续的物理块上，每个物理块设有一个指针指向下一个物理块。

    - 优点：
      1. 提高了磁盘空间利用率，不存在外部碎片问题。
      2. 有利于文件插入和删除，及其动态扩充。
    - 缺点：
      1. 仍然不支持随机查找。
      2. 由于存储空间可能不连续，带来更多的寻道次数和寻道时间。
      3. 需要牺牲一些空间存放链接指针，同时需要维护这些指针，增加了系统开销。
      4. 可靠性问题，如指针出错。

  - **索引结构**：将逻辑上连续的文件信息(记录)存放在不连续的物理块中，系统为每个文件建立一个专用数据结构——索引表，索引表中存放文件的逻辑块号和物理块号的对应关系。 

    - 优点：
      1. 即能顺序存取,又能直接存取。
      2. 满足了文件动态增长、插入删除的要求。
      3. 没有外碎片，外存空间利用率较高。
    - 缺点：
      1. 较多的寻道次数和寻道时间。
      2. 索引表本身需要存储空间，同时对索引表的维护会增加系统开销。

    **UNIX 文件系统的索引结构：**

    **四种寻址方式：直接、一级间接、二级间接、三级间接**

  - **Hash 文件**：采用计算寻址结构，它由主文件和溢出文件组成 

    在每个记录中需要有一个关键字字段，检索时给出记录键值，通过哈希函数计算出该记录在文件中的相对位置。这就是通常所说的Hash方法（散列法或杂凑法），利用这种方法所建立的文件称为Hash文件。 

### 文件的存取方式

- **顺序存取：**指对文件中的信息按顺序依次读写的方式在提供记录式文件结构的系统中，顺序存取法就是严格按物理记录排列的顺序依次读取。 
- **随机存取：**
  - **直接存取法：**允许用户随意存取文件中任意一个物理记录。
  - **按键存取法：** 根据文件中各记录的某个数据项内容来存取记录的，这种数据项称之为“键”。 （Hash）

### 文件目录

文件控制块（FCB）的有序集合称为文件目录，文件目录是由文件控制块组成的，专门用于文件的检索，实现「按名存取」

> **文件控制块的主要内容及作用：**
>
> - 基本信息类：文件名、文件的物理地址
> - 存取控制信息类：文件的存取权限
> - 使用信息类：文件建立日期、修改日期、访问日期、当前使用的信息

**文件目录提供的功能：**

- **实现“按名存取”**。用户只须提供文件名，即可对文件进行存取。这是文件系统向用户提供的最基本的服务。
- **提高对目录的检索速度**。合理地组织目录结构，加快对目录的检索速度，从而加快对文件的存取速度。这是在设计一个大、中型文件系统时，所追求的主要目标。 
- **实现文件共享**。在多用户系统中，应允许多个用户共享一个文件，以节省大量的存储空间并方便用户。
- **解决文件重名问题**。系统应允许不同用户对不同文件采用相同的名字，以便于用户按照自己的习惯命名和使用文件。

**文件目录结构：**

- **一级目录结构：** 优点：简单；缺点：1. 查找速度慢 2. 不允许重名 3.不便于实现文件共享

- **二级目录结构：** 为每一个用户建立一个单独的用户文目录UFD

- **多级目录：**或称为树状目录。在文件数目较多时，便于系统和用户将文件分散管理。适用于较大的文件系统管理。 

  **优点:**

  - 提高了检索目录的速度
  - 较好地解决了重名问题

  **缺点：**

  - 这种结构不便于用户共享文件

**记录的成组与分解**

把若干个逻辑记录合成一组存放在一个物理块的过程。进行成组操作时必须使用主存缓冲区，缓冲区的长度等于逻辑记录长度乘以成组的块因子。

记录成组的优点是提高了存储空间的利用率；减少了启动外设的次数，提高系统的工作效率。主要缺点是需要软件增加成组和分解的额外操作，以及容纳最大块长的I/O缓冲区。

## 外存空间管理

外存空闲空间管理的数据结构通常称为 **磁盘分配表**

常用的空闲空间的管理方法有：**空闲区表、位示图和空闲块链**三种。

**Unix 系统的成组链接法**

将空闲块分成若干组，每100个空闲块为一组。每组的第一个空闲块登记了下一组空闲块的物理盘块号和本组空闲块总数 。 

理解掌握分配和回收空闲盘块的算法

![mark](http://7xjpym.com1.z0.glb.clouddn.com/blog/180706/EifL95JmB9.png?imageslim)

### 文件空间的分配和管理

常用的外存分配方法

- 连续分配
- 链接分配
- 索引分配

### 内存中所需的表目

> 为了提高系统的工作效率，在内存设置文件管理机构称为打开文件机构

1. **内存文件控制块（内存 I 节点）**

   > 当打开某一个文件时，如果找不到其相应的内存I节点，就在内存I节点表中分配一个空闲表项，并将该文件的外存I节点中的主要部分复制进去，填入外存I节点号。

   每一个打开的文件，只能有一个内存文件控制块

2. **系统打开文件表**

   子进程共享父进程的全部打开文件，系统打开文件表共用，修改`f_count` 计数+1

3. **用户（进程）打开文件表**

   每一个进程都有一张用户打开文件表，子进程在父进程的打开文件表的基础上增加表项

## 文件共享

- **基于索引节点的共享**：

  - **静态共享**(硬链接)

    一个文件同时属于多个文件目录项(例如被多个用户共享)，并且这种关系不管文件此时是否在被使用，都存在。 

    Unix 通过**索引节点**（inode）来实现文件共享链接的，并且只允许链接到文件，不允许链接到目录

  - **动态共享**

    出现在进程共享文件时，伴随着进程的生成而存在，进程的终止而消失。 

    - **不共享读写指针的文件共享：** 不共用系统打开文件表项，共用内存活动 I 节点
    - **共享读写指针的文件共享：** 共用系统打开文件表项

- **利用符号链接共享**

  - 软连接：也称符号链接，**生成符号链接文件**时，将符号链接文件登记在该用户共享目录项中，文件内容为被链接文件的路径名。

## 可靠性与安全性

### 转储和恢复

常用的转储方法：**静态转储和动态转储、海量转储和增量转储**

### 存取控制

- 存取控制矩阵
- 存取控制表
- 用户权限表

## 磁盘调度

先进行移臂调度、然后进行旋转调度

### 磁盘移臂调度算法

- **先来先服务：** 根据请求的先后顺序调度，公平，简单。平均寻道距离大

- **最短寻道时间有先 SSTF：**访问的磁道与当前磁头所在的磁道距离最近，不能保证平均寻道时间最短，可能导致「饥饿」现象

- **扫描算法 SCAN ：** 又称「电梯调度」电梯总是保持一个方向运行，直到该方向没有请求为止，然后改变运行方向。电梯算法（扫描算法）和电梯的运行过程类似，总是按一个方向来进行磁盘调度，直到该方向上没有未完成的磁盘请求，然后改变方向。

  因为考虑了移动方向，因此所有的磁盘请求都会被满足，解决了 SSTF 的饥饿问题。

- **循环扫描调度 CSCAN：**磁头只做单向运动

### 磁盘旋转调度算法

同一柱面，扇区号从小往大依次访问，遇到相同扇区号，选择一个访问，另一个下一周访问











